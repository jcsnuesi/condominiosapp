<!-- Admin-only Documentation Module built with PrimeNG -->

<div class="card mt-2">
    <!-- Access control -->
    <ng-container *appHasPermissions="['admin', 'staff_admin']">
        <section class="docs-admin">
            <h2>Documentation Management</h2>
            <p class="subtitle">
                Upload, manage, and maintain official documents across
                condominiums.
            </p>
            <hr />

            <!-- Documents Table -->
            <div class="panel">
                <div
                    style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 4px;
                    "
                >
                    <div class="title-cp">
                        <h3>Documents</h3>
                    </div>
                    <div>
                        <!-- New Inquiry Button -->
                        <p-button
                            label="New document"
                            icon="pi pi-plus"
                            (onClick)="openInquiryDialog()"
                            styleClass="p-button-primary p-button-raised"
                        ></p-button>
                    </div>
                </div>
                <p-table
                    [value]="docModelTable"
                    [paginator]="true"
                    [rows]="10"
                    [loading]="isLoading"
                    [responsiveLayout]="'scroll'"
                    [rowHover]="true"
                >
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Condominium</th>
                            <th>Uploaded</th>
                            <th>Uploaded By</th>
                            <th>Status</th>
                            <th style="width: 220px">Actions</th>
                        </tr>
                    </ng-template>

                    <ng-template
                        pTemplate="body"
                        let-doc
                        let-rowIndex="rowIndex"
                    >
                        <tr>
                            <td>
                                <div class="doc-name">{{ doc?.title }}</div>
                                <div class="doc-desc" *ngIf="doc.description">
                                    {{ doc.description }}
                                </div>
                            </td>
                            <td>
                                <i
                                    *ngFor="let file of doc.file"
                                    [class]="getFileIcon(file.mimetype)"
                                    class="mr-2"
                                    [style.color]="
                                        getFileIconColor(file.mimetype)
                                    "
                                ></i>
                            </td>
                            <td>
                                {{ doc.condoId.alias }}
                            </td>
                            <td>
                                {{ doc.createdAt | date : "mediumDate" }}
                            </td>
                            <td>
                                {{ doc.createdBy.email }}
                            </td>
                            <td>
                                <p-tag
                                    [severity]="
                                        tagSeverityForStatus(doc?.status)
                                    "
                                    [value]="doc?.status"
                                ></p-tag>
                            </td>
                            <td class="actions">
                                <button
                                    pButton
                                    type="button"
                                    label="View"
                                    icon="pi pi-eye"
                                    class="p-button-text"
                                    (click)="onView(doc)"
                                ></button>
                                <button
                                    pButton
                                    type="button"
                                    label="Download"
                                    icon="pi pi-download"
                                    class="p-button-text"
                                    (click)="onDownload(doc)"
                                ></button>
                                <button
                                    pButton
                                    type="button"
                                    label="Edit"
                                    icon="pi pi-pencil"
                                    class="p-button-text"
                                    (click)="onEdit(doc)"
                                ></button>
                                <button
                                    pButton
                                    type="button"
                                    label="Delete"
                                    icon="pi pi-trash"
                                    class="p-button-danger p-button-text"
                                    (click)="onDelete(doc)"
                                ></button>
                            </td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="7" class="empty">
                                No documents available.
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </section>
    </ng-container>
</div>

<!-- Access denied template -->
<ng-template #accessDenied>
    <section class="access-denied">
        <h2>Access Denied</h2>
        <p>
            You do not have permission to view this module. ADMIN role is
            required.
        </p>
    </section>
</ng-template>

<p-dialog
    [header]="dialogHeader"
    [(visible)]="displayDocsDialog"
    [modal]="true"
    [style]="{ width: '700px', maxHeight: '90vh' }"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
>
    <form #docsForm="ngForm" (ngSubmit)="submitDocs()">
        <!-- ✅ Title Field - FORMATO UNIFICADO -->
        <div class="field mb-3">
            <label for="inquiry-title" class="block font-semibold mb-2">
                <i class="pi pi-pencil mr-1"></i>
                Title *
            </label>
            <input
                id="inquiry-title"
                type="text"
                pInputText
                [(ngModel)]="docModel.title"
                name="title"
                required
                maxlength="200"
                placeholder="Brief description of your inquiry"
                class="w-full"
                [disabled]="!isAdmin()"
            />
            <small class="text-500 block mt-1">
                {{ docModel?.title?.length }} / 200 characters
            </small>
        </div>

        <!-- ✅ Resident & Apartment (Read-only UI) -->
        <div class="field mb-3" *ngIf="isDashboard">
            <label class="block font-semibold mb-2">
                <i class="pi pi-home mr-1"></i>
                Residential
            </label>
            <div class="grid">
                <div class="col">
                    <label
                        for="inquiry-residential"
                        class="block text-sm text-600 mb-2"
                        >Residential</label
                    >
                    <p-dropdown
                        #CondoId="ngModel"
                        name="CondoId"
                        [(ngModel)]="docModel.condominiumId"
                        id="inquiry-residential"
                        [options]="dataDocs"
                        placeholder="Your residential"
                        styleClass="w-full"
                        optionLabel="label"
                        optionValue="value"
                        [disabled]="!isAdmin()"
                    ></p-dropdown>
                </div>
            </div>
        </div>

        <!-- ✅ Category Field - FORMATO UNIFICADO -->
        <div class="field mb-3">
            <label for="inquiry-category" class="block font-semibold mb-2">
                <i class="pi pi-tag mr-1"></i>
                Category *
            </label>
            <p-dropdown
                id="inquiry-category"
                [options]="documentTypeOptions"
                [(ngModel)]="docModel.category"
                name="category"
                required
                optionLabel="label"
                optionValue="value"
                placeholder="Select a category"
                styleClass="w-full"
                [disabled]="!isAdmin()"
            ></p-dropdown>
        </div>

        <!-- ✅ Description Field - FORMATO UNIFICADO -->
        <div class="field mb-3">
            <label for="inquiry-description" class="block font-semibold mb-2">
                <i class="pi pi-align-left mr-1"></i>
                Description *
            </label>
            <textarea
                [disabled]="!isAdmin()"
                id="inquiry-description"
                pInputTextarea
                [(ngModel)]="docModel.description"
                name="description"
                required
                maxlength="2000"
                placeholder="Provide detailed information about your inquiry"
                rows="5"
                class="w-full"
            ></textarea>
            <small class="text-500 block mt-1">
                {{ docModel?.description?.length }} / 2000 characters
            </small>
        </div>

        <!-- ✅ File Upload Section - FORMATO UNIFICADO -->
        <div class="field mb-4">
            <label class="block font-semibold mb-2">
                <i class="pi pi-paperclip mr-1"></i>
                Attachments (Optional)
            </label>

            <p-fileUpload
                #fileUploader
                name="attachments[]"
                [multiple]="true"
                [maxFileSize]="10000000"
                [showUploadButton]="false"
                [showCancelButton]="false"
                [customUpload]="true"
                (onSelect)="onFileSelect($event)"
                (onRemove)="onFileRemove($event)"
                (onClear)="onFilesClear()"
                accept="image/*,.pdf,.doc,.docx,.txt, .xls, .xlsx"
                [auto]="false"
                chooseLabel="Choose Files"
                chooseIcon="pi pi-cloud-upload"
                styleClass="w-full"
                [disabled]="!isAdmin()"
            >
                <ng-template pTemplate="content">
                    <div class="mt-3">
                        <!-- Files List -->
                        <div
                            *ngIf="selectedFiles.length > 0"
                            class="uploaded-files-list"
                        >
                            <div
                                *ngFor="
                                    let file of selectedFiles;
                                    let i = index
                                "
                                class="file-item p-3 mb-2 border-round surface-100 flex align-items-center justify-content-between"
                            >
                                <div
                                    class="flex align-items-center gap-3 flex-1"
                                >
                                    <!-- File Icon -->
                                    <div class="file-icon">
                                        <i
                                            [class]="getFileIcon(file.type)"
                                            class="text-3xl"
                                            [style.color]="
                                                getFileIconColor(file.type)
                                            "
                                        ></i>
                                    </div>

                                    <!-- File Info -->
                                    <div class="file-info flex-1">
                                        <div class="font-semibold text-900">
                                            {{ file.name }}
                                        </div>
                                        <div class="text-sm text-600">
                                            {{ formatFileSize(file.size) }}
                                            <span class="mx-2">•</span>
                                            <span class="text-500">{{
                                                getFileExtension(file.name)
                                            }}</span>
                                        </div>
                                    </div>

                                    <!-- Image Preview -->
                                    <div
                                        *ngIf="isImage(file)"
                                        class="file-preview"
                                        [style.background-image]="
                                            'url(' + getFilePreview(file) + ')'
                                        "
                                    ></div>
                                </div>
                                <!-- Download Button -->
                                <p-button
                                    icon="pi pi-download"
                                    (onClick)="downloadExistingAttachment(file)"
                                    styleClass="p-button-rounded p-button-text p-button-primary p-button-sm mr-2"
                                    pTooltip="Download file"
                                    tooltipPosition="left"
                                ></p-button>

                                <!-- Remove Button -->
                                <p-button
                                    icon="pi pi-times"
                                    (onClick)="removeFile(i)"
                                    styleClass="p-button-rounded p-button-text p-button-danger p-button-sm"
                                    pTooltip="Remove file"
                                    tooltipPosition="left"
                                    [ngStyle]="{
                                        display: !isAdmin()
                                            ? 'none'
                                            : 'inline-block'
                                    }"
                                ></p-button>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div
                            *ngIf="selectedFiles.length === 0"
                            class="empty-file-state"
                        >
                            <i
                                class="pi pi-cloud-upload text-4xl text-400 mb-2"
                            ></i>
                            <p class="text-600 m-0 mb-2">
                                Drag and drop files here or click to browse
                            </p>
                            <small class="text-500">
                                Max file size: 10MB | Accepted: Images, PDF,
                                DOC, TXT
                            </small>
                        </div>
                    </div>
                </ng-template>
            </p-fileUpload>

            <!-- File Upload Info -->
            <div
                class="flex align-items-center gap-3 mt-2"
                *ngIf="selectedFiles.length > 0"
            >
                <small class="text-500">
                    <i class="pi pi-info-circle mr-1"></i>
                    {{ selectedFiles.length }} file(s) selected ({{
                        getTotalFilesSize()
                    }})
                </small>
                <p-button
                    label="Clear All"
                    icon="pi pi-trash"
                    (onClick)="clearAllFiles()"
                    styleClass="p-button-text p-button-sm p-button-danger"
                    [disabled]="selectedFiles.length === 0"
                    [ngStyle]="{
                        display: !isAdmin() ? 'none' : 'inline-block'
                    }"
                ></p-button>
            </div>
        </div>

        <!-- ✅ Action Buttons - FORMATO UNIFICADO -->
        <div
            class="flex justify-content-end gap-2 pt-3 border-top-1 surface-border"
        >
            <p-button
                label="Cancel"
                icon="pi pi-times"
                (onClick)="closeInquiryDialog()"
                styleClass="p-button-text"
                type="button"
            ></p-button>
            <p-button
                label="Submit"
                icon="pi pi-check"
                type="submit"
                [loading]="loading"
                [disabled]="!docsForm.form.valid"
                [ngStyle]="{ display: isAdmin() ? 'inline-block' : 'none' }"
            ></p-button>
        </div>
    </form>
</p-dialog>
