<div class="notification-container card mt-4">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <!-- Header Section -->
    <div class="notification-header mb-4">
        <div class="flex justify-content-between align-items-center">
            <div>
                <h2 class="text-2xl font-bold text-primary">
                    Notifications & Inquiries
                </h2>
                <p class="text-600 mt-1">
                    Manage your communications with the administration
                </p>
            </div>
            <div class="flex gap-2">
                <p-button
                    label="New Inquiry"
                    icon="pi pi-plus"
                    (onClick)="openInquiryDialog()"
                    class="p-button-primary"
                >
                </p-button>
                <p-button
                    label="Mark All Read"
                    icon="pi pi-check-circle"
                    (onClick)="markAllNoticesAsRead()"
                    class="p-button-outlined"
                    [disabled]="unreadNoticesCount === 0"
                >
                    <p-badge
                        [value]="unreadNoticesCount"
                        *ngIf="unreadNoticesCount > 0"
                    ></p-badge>
                </p-button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid mb-4">
        <div class="col-12 md:col-3">
            <p-card class="stats-card">
                <div class="flex align-items-center">
                    <div
                        class="bg-blue-100 text-blue-600 border-round"
                        [ngStyle]="{ padding: '0.5rem' }"
                    >
                        <i class="pi pi-file-o text-2xl"></i>
                    </div>
                    <div class="ml-3">
                        <div class="text-600 text-sm">Total Inquiries</div>
                        <div class="text-900 text-xl font-semibold">
                            {{ inquiryStats.total }}
                        </div>
                    </div>
                </div>
            </p-card>
        </div>
        <div class="col-12 md:col-3">
            <p-card class="stats-card">
                <div class="flex align-items-center">
                    <div
                        class="stat-icon bg-orange-100 text-orange-600 border-round"
                        [ngStyle]="{ padding: '0.5rem' }"
                    >
                        <i class="pi pi-clock text-2xl"></i>
                    </div>
                    <div class="ml-3">
                        <div class="text-600 text-sm">Open</div>
                        <div class="text-900 text-xl font-semibold">
                            {{ inquiryStats.open }}
                        </div>
                    </div>
                </div>
            </p-card>
        </div>
        <div class="col-12 md:col-3">
            <p-card class="stats-card">
                <div class="flex align-items-center">
                    <div
                        class="stat-icon bg-yellow-100 text-yellow-600 border-round"
                        [ngStyle]="{ padding: '0.5rem' }"
                    >
                        <i class="pi pi-refresh text-2xl"></i>
                    </div>
                    <div class="ml-3">
                        <div class="text-600 text-sm">In Progress</div>
                        <div class="text-900 text-xl font-semibold">
                            {{ inquiryStats.inProgress }}
                        </div>
                    </div>
                </div>
            </p-card>
        </div>
        <div class="col-12 md:col-3">
            <p-card class="stats-card">
                <div class="flex align-items-center">
                    <div
                        class="stat-icon bg-green-100 text-green-600 border-round"
                        [ngStyle]="{ padding: '0.5rem' }"
                    >
                        <i class="pi pi-check-circle text-2xl"></i>
                    </div>
                    <div class="ml-3">
                        <div class="text-600 text-sm">Resolved</div>
                        <div class="text-900 text-xl font-semibold">
                            {{ inquiryStats.resolved }}
                        </div>
                    </div>
                </div>
            </p-card>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <p-tabView>
        <!-- Inquiries Tab -->
        <p-tabPanel header="Inquiries" leftIcon="pi pi-file-o">
            <div class="inquiry-section">
                <!-- Filters -->
                <div
                    class="flex justify-content-between align-items-center mb-3"
                >
                    <div class="flex align-items-center gap-2">
                        <label for="statusFilter" class="font-semibold text-sm"
                            >Filter by Status:</label
                        >
                        <p-dropdown
                            id="statusFilter"
                            [options]="statusOptions"
                            [(ngModel)]="inquiryStatusFilter"
                            optionLabel="label"
                            optionValue="value"
                            [style]="{ 'min-width': '140px' }"
                        >
                        </p-dropdown>
                    </div>
                    <p-button
                        label="Refresh"
                        icon="pi pi-refresh"
                        (onClick)="loadInquiries()"
                        class="p-button-outlined p-button-sm"
                    >
                    </p-button>
                </div>

                <!-- Inquiries Table -->
                <p-table
                    [value]="getFilteredInquiries()"
                    [loading]="loading"
                    [paginator]="true"
                    [rows]="inquiryRows"
                    [first]="inquiryFirst"
                    (onPageChange)="onInquiryPageChange($event)"
                    responsiveLayout="scroll"
                    [globalFilterFields]="['title', 'type', 'status']"
                >
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Responses</th>
                            <th>Actions</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-inquiry>
                        <tr>
                            <td>
                                <div class="font-semibold">
                                    {{ inquiry.title }}
                                </div>
                                <div class="text-sm text-600">
                                    {{
                                        inquiry.description | slice : 0 : 50
                                    }}...
                                </div>
                            </td>
                            <td>
                                <p-tag
                                    [value]="inquiry.type"
                                    severity="secondary"
                                ></p-tag>
                            </td>
                            <td>
                                <p-tag
                                    [value]="inquiry.priority"
                                    [severity]="
                                        getPriorityClass(inquiry.priority)
                                    "
                                ></p-tag>
                            </td>
                            <td>
                                <p-tag
                                    [value]="inquiry.status"
                                    [severity]="getStatusClass(inquiry.status)"
                                ></p-tag>
                            </td>
                            <td>{{ formatDate(inquiry.createdAt!) }}</td>
                            <td>
                                <p-badge
                                    [value]="inquiry.responses?.length || 0"
                                    class="p-badge-info"
                                ></p-badge>
                            </td>
                            <td>
                                <p-button
                                    icon="pi pi-eye"
                                    (onClick)="viewInquiryDetails(inquiry)"
                                    class="p-button-text p-button-sm"
                                    pTooltip="View Details"
                                >
                                </p-button>
                            </td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="7">
                                <div class="text-center p-4">
                                    <i
                                        class="pi pi-inbox text-4xl text-400 mb-3"
                                    ></i>
                                    <div class="text-600">
                                        No inquiries found
                                    </div>
                                    <p-button
                                        label="Create Your First Inquiry"
                                        icon="pi pi-plus"
                                        (onClick)="openInquiryDialog()"
                                        class="p-button-text mt-2"
                                    >
                                    </p-button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </p-tabPanel>

        <!-- Notices Tab -->
        <p-tabPanel header="Notices" leftIcon="pi pi-bell">
            <div class="notice-section">
                <!-- Filters -->
                <div
                    class="flex justify-content-between align-items-center mb-3"
                >
                    <div class="flex align-items-center gap-2">
                        <label
                            for="noticeTypeFilter"
                            class="font-semibold text-sm"
                            >Filter by Type:</label
                        >
                        <p-dropdown
                            id="noticeTypeFilter"
                            [options]="noticeTypeOptions"
                            [(ngModel)]="noticeTypeFilter"
                            optionLabel="label"
                            optionValue="value"
                            [style]="{ 'min-width': '140px' }"
                        >
                        </p-dropdown>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <span class="text-sm text-600"
                            >Unread: {{ unreadNoticesCount }}</span
                        >
                        <p-button
                            label="Refresh"
                            icon="pi pi-refresh"
                            (onClick)="loadNotices()"
                            class="p-button-outlined p-button-sm"
                        >
                        </p-button>
                    </div>
                </div>

                <!-- Notices List -->
                <div class="notices-list">
                    <div
                        *ngFor="
                            let notice of getFilteredNotices();
                            let i = index
                        "
                        class="notice-card mb-3"
                        [class.unread]="!notice.isRead"
                        (click)="viewNoticeDetails(notice)"
                    >
                        <p-card [style]="{ cursor: 'pointer' }">
                            <div
                                class="flex justify-content-between align-items-start"
                            >
                                <div class="flex-1">
                                    <div
                                        class="flex align-items-center gap-2 mb-2"
                                    >
                                        <h4 class="m-0 text-900">
                                            {{ notice.title }}
                                        </h4>
                                        <p-tag
                                            [value]="notice.type"
                                            [ngClass]="
                                                getNoticeTypeClass(notice.type)
                                            "
                                        ></p-tag>
                                        <p-tag
                                            [value]="notice.priority"
                                            [ngClass]="
                                                getPriorityClass(
                                                    notice.priority
                                                )
                                            "
                                        ></p-tag>
                                        <p-badge
                                            value="NEW"
                                            *ngIf="!notice.isRead"
                                            class="p-badge-danger"
                                        ></p-badge>
                                    </div>
                                    <p class="text-600 m-0">
                                        {{
                                            notice.content | slice : 0 : 150
                                        }}...
                                    </p>
                                    <div class="text-sm text-500 mt-2">
                                        <i class="pi pi-calendar mr-1"></i>
                                        {{ formatDate(notice.createdAt!) }}
                                    </div>
                                </div>
                                <i class="pi pi-chevron-right text-400"></i>
                            </div>
                        </p-card>
                    </div>

                    <!-- Empty State -->
                    <div
                        *ngIf="getFilteredNotices().length === 0"
                        class="text-center p-4"
                    >
                        <i class="pi pi-bell-slash text-4xl text-400 mb-3"></i>
                        <div class="text-600">No notices available</div>
                    </div>
                </div>

                <!-- Pagination for Notices -->
                <p-paginator
                    [rows]="noticeRows"
                    [totalRecords]="getFilteredNotices().length"
                    [first]="noticeFirst"
                    (onPageChange)="onNoticePageChange($event)"
                    *ngIf="getFilteredNotices().length > noticeRows"
                >
                </p-paginator>
            </div>
        </p-tabPanel>
    </p-tabView>

    <!-- Create Inquiry Dialog -->
    <p-dialog
        header="Create New Inquiry"
        [(visible)]="displayInquiryDialog"
        [modal]="true"
        [style]="{ width: '600px' }"
        [closable]="true"
        [draggable]="false"
    >
        <form #inquiryForm="ngForm" (ngSubmit)="submitInquiry()">
            <div class="field mb-3">
                <label for="title" class="block font-semibold mb-2"
                    >Title *</label
                >
                <input
                    id="title"
                    type="text"
                    pInputText
                    [(ngModel)]="newInquiry.title"
                    name="title"
                    required
                    placeholder="Brief description of your inquiry"
                    class="w-full"
                />
            </div>

            <div class="field mb-3">
                <label for="category" class="block font-semibold mb-2"
                    >Category *</label
                >
                <p-dropdown
                    id="category"
                    [options]="categoryOptions"
                    [(ngModel)]="newInquiry.category"
                    name="category"
                    required
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Select a category"
                    class="w-full"
                >
                </p-dropdown>
            </div>

            <div class="field mb-3">
                <label for="priority" class="block font-semibold mb-2"
                    >Priority</label
                >
                <p-dropdown
                    id="priority"
                    [options]="priorityOptions"
                    [(ngModel)]="newInquiry.priority"
                    name="priority"
                    optionLabel="label"
                    optionValue="value"
                    class="w-full"
                >
                </p-dropdown>
            </div>

            <div class="field mb-4">
                <label for="description" class="block font-semibold mb-2"
                    >Description *</label
                >
                <textarea
                    id="description"
                    pInputTextarea
                    [(ngModel)]="newInquiry.description"
                    name="description"
                    required
                    placeholder="Provide detailed information about your inquiry"
                    rows="4"
                    class="w-full"
                >
                </textarea>
            </div>

            <div class="flex justify-content-end gap-2">
                <p-button
                    label="Cancel"
                    icon="pi pi-times"
                    (onClick)="displayInquiryDialog = false"
                    class="p-button-text"
                >
                </p-button>
                <p-button
                    label="Submit"
                    icon="pi pi-check"
                    type="submit"
                    [loading]="loading"
                    [disabled]="!inquiryForm.form.valid"
                >
                </p-button>
            </div>
        </form>
    </p-dialog>

    <!-- Inquiry Details Dialog -->
    <p-dialog
        [(visible)]="displayInquiryDetailDialog"
        header="Inquiry Details"
        [modal]="true"
        [style]="{ width: '900px', maxHeight: '90vh' }"
        [draggable]="false"
        [resizable]="false"
    >
        <div *ngIf="selectedInquiry" class="inquiry-details">
            <!-- Inquiry Header -->
            <div
                class="inquiry-header mb-4 pb-3 border-bottom-1 surface-border"
            >
                <div
                    class="flex justify-content-between align-items-start mb-2"
                >
                    <h3 class="m-0 text-900">{{ selectedInquiry.title }}</h3>
                    <div class="flex gap-2">
                        <p-tag
                            [value]="selectedInquiry.type"
                            severity="secondary"
                        ></p-tag>
                        <p-tag
                            [value]="selectedInquiry.priority"
                            [severity]="
                                getPriorityClass(selectedInquiry.priority)
                            "
                        ></p-tag>
                        <p-tag
                            [value]="selectedInquiry.status"
                            [severity]="getStatusClass(selectedInquiry.status)"
                        ></p-tag>
                    </div>
                </div>
                <p class="text-600 m-0">{{ selectedInquiry.description }}</p>
                <div class="text-sm text-500 mt-2">
                    Created: {{ formatDate(selectedInquiry.createdAt!) }}
                </div>
            </div>

            <!-- Conversation Timeline -->
            <div class="conversation-section">
                <h4 class="text-900 mb-3">
                    <i class="pi pi-comments mr-2"></i>
                    Conversation History
                </h4>

                <div
                    class="conversation-timeline"
                    style="
                        max-height: 400px;
                        overflow-y: auto;
                        padding-right: 10px;
                    "
                >
                    <!-- Timeline con respuestas -->
                    <p-timeline
                        [value]="selectedInquiry.responses || []"
                        layout="vertical"
                        align="alternate"
                    >
                        <ng-template pTemplate="marker" let-response>
                            <span
                                class="flex align-items-center justify-content-center text-white border-circle z-1 shadow-1"
                                [ngStyle]="{
                                    'background-color': response.isAdminResponse
                                        ? 'var(--primary-color)'
                                        : 'var(--bluegray-500)',
                                    width: '2.5rem',
                                    height: '2.5rem'
                                }"
                            >
                                <i
                                    [class]="
                                        response.isAdminResponse
                                            ? 'pi pi-shield'
                                            : 'pi pi-user'
                                    "
                                ></i>
                            </span>
                        </ng-template>

                        <ng-template pTemplate="content" let-response>
                            <div
                                class="response-item p-3 border-round mb-3 shadow-1"
                                [ngClass]="{
                                    'admin-response': response.isAdminResponse,
                                    'user-response': !response.isAdminResponse
                                }"
                                [ngStyle]="{
                                    'background-color': response.isAdminResponse
                                        ? '#e3f2fd'
                                        : '#f5f5f5',
                                    'border-left': response.isAdminResponse
                                        ? '4px solid var(--primary-color)'
                                        : '4px solid var(--bluegray-500)'
                                }"
                            >
                                <!-- Response Header -->
                                <div
                                    class="flex justify-content-between align-items-center mb-2"
                                >
                                    <div class="flex align-items-center gap-2">
                                        <div class="font-semibold text-900">
                                            {{
                                                response.respondedBy?.name ||
                                                    "Unknown User"
                                            }}
                                            {{
                                                response.respondedBy
                                                    ?.lastname || ""
                                            }}
                                        </div>
                                        <p-tag
                                            [value]="response.respondedByRole"
                                            [severity]="
                                                response.isAdminResponse
                                                    ? 'success'
                                                    : 'info'
                                            "
                                            [icon]="
                                                response.isAdminResponse
                                                    ? 'pi pi-shield'
                                                    : 'pi pi-user'
                                            "
                                        ></p-tag>
                                    </div>
                                    <div class="text-xs text-500">
                                        <i class="pi pi-clock mr-1"></i>
                                        {{ formatDate(response.createdAt) }}
                                    </div>
                                </div>

                                <!-- Response Message -->
                                <p class="m-0 text-700 line-height-3">
                                    {{ response.message }}
                                </p>

                                <!-- Response Footer (optional metadata) -->
                                <div
                                    class="flex align-items-center gap-2 mt-2 pt-2 border-top-1 surface-border"
                                    *ngIf="response.respondedBy?.email"
                                >
                                    <i
                                        class="pi pi-envelope text-xs text-500"
                                    ></i>
                                    <span class="text-xs text-600">{{
                                        response.respondedBy.email
                                    }}</span>
                                </div>
                            </div>
                        </ng-template>

                        <ng-template pTemplate="opposite" let-response>
                            <small class="text-500">{{
                                formatTime(response.createdAt)
                            }}</small>
                        </ng-template>
                    </p-timeline>

                    <!-- Empty State -->
                    <div
                        *ngIf="
                            !selectedInquiry.responses ||
                            selectedInquiry.responses.length === 0
                        "
                        class="text-center p-5 border-round-lg surface-100"
                    >
                        <i
                            class="pi pi-comments text-6xl text-400 mb-3"
                            style="display: block"
                        ></i>
                        <div class="text-600 font-semibold mb-2">
                            No responses yet
                        </div>
                        <p class="text-500 text-sm m-0">
                            Be the first to respond to this inquiry
                        </p>
                    </div>
                </div>

                <!-- Action Buttons Section -->
                <div class="action-section mt-4">
                    <!-- Add Response (if not closed) -->
                    <div
                        class="add-response"
                        *ngIf="selectedInquiry.status !== 'closed'"
                    >
                        <div class="field">
                            <label class="block font-semibold mb-2">
                                <i class="pi pi-reply mr-2"></i>
                                Add Response
                            </label>
                            <textarea
                                pInputTextarea
                                [(ngModel)]="newResponse"
                                placeholder="Type your response here..."
                                rows="3"
                                class="w-full"
                                [maxlength]="2000"
                            ></textarea>
                            <div
                                class="flex justify-content-between align-items-center mt-1"
                            >
                                <small class="text-500">
                                    {{ newResponse.length }} / 2000 characters
                                </small>
                            </div>
                        </div>

                        <div
                            class="flex justify-content-between align-items-center mt-3"
                        >
                            <!-- Close Inquiry Button (Admin Only) -->
                            <p-button
                                *ngIf="isAdmin()"
                                label="Close Inquiry"
                                icon="pi pi-lock"
                                (onClick)="closeInquiry(selectedInquiry._id!)"
                                [loading]="isClosingInquiry"
                                styleClass="p-button-danger p-button-sm"
                                pTooltip="Mark this inquiry as closed and prevent new responses"
                                tooltipPosition="top"
                            >
                            </p-button>

                            <!-- Spacer -->
                            <div class="flex-1"></div>

                            <!-- Send Response Button -->
                            <div class="flex gap-2">
                                <p-button
                                    label="Cancel"
                                    icon="pi pi-times"
                                    (onClick)="clearResponse()"
                                    [disabled]="!newResponse.trim()"
                                    styleClass="p-button-text p-button-sm"
                                >
                                </p-button>
                                <p-button
                                    label="Send Response"
                                    icon="pi pi-send"
                                    (onClick)="addResponseToInquiry()"
                                    [disabled]="!newResponse.trim()"
                                    [loading]="isSendingResponse"
                                    styleClass="p-button-sm"
                                >
                                </p-button>
                            </div>
                        </div>
                    </div>

                    <!-- Closed Notice -->
                    <div
                        *ngIf="selectedInquiry.status === 'closed'"
                        class="closed-notice p-4 border-round-lg bg-red-50 border-1 border-red-200"
                    >
                        <div class="flex align-items-start gap-3">
                            <i
                                class="pi pi-lock text-red-600 text-2xl"
                                style="margin-top: 0.25rem"
                            ></i>
                            <div class="flex-1">
                                <div class="font-semibold text-red-900 mb-2">
                                    Inquiry Closed
                                </div>
                                <p
                                    class="text-red-700 m-0 text-sm line-height-3"
                                >
                                    This inquiry has been marked as closed and
                                    no longer accepts new responses. If you need
                                    further assistance, please create a new
                                    inquiry.
                                </p>
                                <div
                                    class="mt-3"
                                    *ngIf="
                                        selectedInquiry.closedAt ||
                                        selectedInquiry.closedBy
                                    "
                                >
                                    <small class="text-red-600">
                                        <i class="pi pi-info-circle mr-1"></i>
                                        Closed
                                        <span *ngIf="selectedInquiry.closedAt">
                                            on
                                            {{
                                                formatDate(
                                                    selectedInquiry.closedAt
                                                )
                                            }}
                                        </span>
                                        <span *ngIf="selectedInquiry.closedBy">
                                            by
                                            {{ selectedInquiry.closedBy.name }}
                                        </span>
                                    </small>
                                </div>
                            </div>

                            <!-- Reopen Button (Admin Only) -->
                            <p-button
                                *ngIf="isAdmin()"
                                label="Reopen"
                                icon="pi pi-refresh"
                                (onClick)="reopenInquiry(selectedInquiry._id!)"
                                [loading]="isReopeningInquiry"
                                styleClass="p-button-text p-button-sm p-button-danger"
                                pTooltip="Reopen this inquiry to allow new responses"
                                tooltipPosition="top"
                            >
                            </p-button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </p-dialog>

    <!-- Notice Details Dialog -->
    <p-dialog
        header="Notice Details"
        [(visible)]="displayNoticeDialog"
        [modal]="true"
        [style]="{ width: '600px' }"
        [closable]="true"
    >
        <!-- This will be populated when viewing notice details -->
        <div class="notice-content">
            <!-- Notice details will be shown here -->
        </div>
    </p-dialog>
</div>
